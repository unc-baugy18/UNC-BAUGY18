<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archives Photos 2025 - UNC de Baugy</title>

    <meta name="description" content="Dossiers photos de l'année 2025 de l'Union Nationale des Combattants de BAUGY.">

    <link rel="stylesheet" href="UNC de Baugy_fichiers/style.css">
</head>
<body>

<div class="header" style="display: flex; align-items: center; justify-content: center; flex-direction: column;">
    <div style="display: flex; align-items: center; text-align: center;">
        <h1 style="font-size:1.2em; line-height:1.3; margin:0; text-align:center; letter-spacing:3px;">
            Union Nationale<br>
            des Combattants<br>
            de BAUGY
        </h1>
        <img src="UNC de Baugy_fichiers/logo unc.png" alt="Logo UNC" style="height:60px; margin-left:20px;">
    </div>
    <p style="font-size:1em; margin:0; text-align:center;">Le devoir de mémoire, un engagement pour l'avenir.</p>
</div>

<div class="navbar">
    <a href="index.html">Accueil</a>
    <a href="presentation.html">Présentation</a>
    <a href="magazine.html">Magazine</a>
    <a href="actualites.html">Actualités</a>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSftKzOvljhTeNUzij3CgJCsjs0ZR_k9b0PSTW2Opl1pQCTkCg/viewform?usp=header">Adhérer</a>
    <a href="archives-photos.html" class="active">Photos</a>
    <a href="contact.html">Contact</a>
</div>

<div class="contact-wrap">
  <div class="section" id="folder-view">
    <h2>Dossiers Photos de l'Année 2025</h2>

    <div style="text-align:center; margin: 20px;">
      <button onclick="testGoogleSheetConnection()" style="padding:10px 20px; font-size:1em; border-radius:8px; background:#1E4A7B; color:white; border:none; cursor:pointer;">
        Tester connexion Google Sheets
      </button>
    </div>

    <div class="bureau-grid">
      <p id="loading-folders" style="text-align: center; padding: 20px;">Chargement des dossiers...</p>
    </div>
  </div>

  <div class="section gallery-container" id="gallery-view">
    <h2 id="gallery-title"></h2>
    <button class="card" onclick="showFolderView()" style="margin-bottom: 20px;">Retour aux dossiers</button>

    <div class="slideshow-container"></div>
    <br>
  </div>
</div>

<!-- Lightbox Modal -->
<div id="myLightbox" class="lightbox-modal" style="display: none;">
  <span class="close-lightbox" onclick="closeLightBox()">&times;</span>
  <img class="lightbox-content" id="img01">
</div>

<div class="footer">
    <p>&copy; 2025 UNC de Baugy. Tous droits réservés.</p>
</div>

<script>
    // --- CONFIG GOOGLE SHEETS ---
    const GOOGLE_SHEET_API_KEY = "AIzaSyDG44Qj6RBpy1R_rgSZvs2-n5gorCAsokU"; 
    const GOOGLE_SHEET_ID = "1fon3ys-2OU6PCoxAi3nBObV2edTx4Y5I6JI60FBg9uY"; 
    const GOOGLE_SHEET_RANGE = "Feuille 1!A:E"; 
    const CURRENT_YEAR = 2025; 

    // --- DONNÉES DE FALLBACK ---
    let folderImages = {
      "Mechoui": [
        { src: "https://placehold.co/800x600/226e93/ffffff?text=Image+de+test", caption: "Ceci est une image de test" },
      ]
    };

    let slideIndex = 1;
    let currentGalleryImages = [];

    const folderView = document.getElementById("folder-view");
    const folderGrid = folderView.querySelector(".bureau-grid");
    const loadingFoldersMessage = document.getElementById("loading-folders");
    const galleryView = document.getElementById("gallery-view");
    const galleryTitle = document.getElementById("gallery-title");
    const slideshowContainer = galleryView.querySelector(".slideshow-container");
    const lightboxModal = document.getElementById("myLightbox");
    const lightboxImg = document.getElementById("img01");

    // --- Convertisseur lien Drive -> lien direct image ---
    function convertDriveLink(url) {
      if (!url) return url;
      let match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match) {
        return `https://drive.google.com/uc?export=view&id=${match[1]}`;
      }
      if (url.includes("uc?export=view&id=")) {
        return url;
      }
      return url;
    }

    // --- Vue dossiers ---
    function showFolderView() {
      folderView.style.display = "block";
      galleryView.style.display = "none";
      slideshowContainer.innerHTML = "";
      currentGalleryImages = [];
      slideIndex = 1;
      renderFolderCards();
    }

    // --- Vue galerie ---
    function showGalleryView(folderName) {
      folderView.style.display = "none";
      galleryView.style.display = "block";
      galleryTitle.textContent = `Photos du dossier : ${folderName}`;

      currentGalleryImages = folderImages[folderName] || [];
      if (currentGalleryImages.length > 0) {
        slideshowContainer.innerHTML = "";
        currentGalleryImages.forEach((img, index) => {
          const slideDiv = document.createElement("div");
          slideDiv.classList.add("mySlides", "fade");
          slideDiv.innerHTML = `
            <div class="numbertext">${index + 1} / ${currentGalleryImages.length}</div>
            <img src="${img.src}" alt="${img.caption}" onclick="openLightBox('${img.src}')">
            <div class="text">${img.caption}</div>
          `;
          slideshowContainer.appendChild(slideDiv);
        });

        const prevButton = document.createElement("a");
        prevButton.classList.add("prev");
        prevButton.innerHTML = "&#10094;";
        prevButton.onclick = () => plusSlides(-1);
        slideshowContainer.appendChild(prevButton);

        const nextButton = document.createElement("a");
        nextButton.classList.add("next");
        nextButton.innerHTML = "&#10095;";
        nextButton.onclick = () => plusSlides(1);
        slideshowContainer.appendChild(nextButton);

        showSlides(1);
      } else {
        slideshowContainer.innerHTML = "<p style='text-align:center; padding:20px;'>Aucune photo trouvée pour ce dossier.</p>";
      }
    }

    // --- Diaporama ---
    function plusSlides(n) { showSlides(slideIndex += n); }
    function currentSlide(n) { showSlides(slideIndex = n); }
    function showSlides(n) {
      const slides = slideshowContainer.getElementsByClassName("mySlides");
      if (slides.length === 0) return;
      if (n > slides.length) {slideIndex = 1}
      if (n < 1) {slideIndex = slides.length}
      for (let i = 0; i < slides.length; i++) slides[i].style.display = "none";
      slides[slideIndex-1].style.display = "block";
    }

    // --- Lightbox ---
    function openLightBox(imgSrc) {
      lightboxModal.style.display = "flex";
      lightboxImg.src = imgSrc;
    }
    function closeLightBox() { lightboxModal.style.display = "none"; }

    // --- Récupération depuis Google Sheets ---
    async function fetchGoogleSheetData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${GOOGLE_SHEET_RANGE}?key=${GOOGLE_SHEET_API_KEY}`;
      try {
        loadingFoldersMessage.textContent = "Chargement des dossiers depuis Google Sheets...";
        const response = await fetch(url);
        if (!response.ok) throw new Error("Erreur HTTP: " + response.status);
        const data = await response.json();

        if (data.values && data.values.length > 1) {
          const headers = data.values[0];
          const rows = data.values.slice(1);
          const newFolderImages = {};

          rows.forEach(row => {
            const rowData = {};
            headers.forEach((header, index) => { rowData[header] = row[index]; });

            if (parseInt(rowData.Annee) === CURRENT_YEAR) {
              const folderName = rowData.Dossier;
              if (folderName && rowData.Source_Drive) {
                if (!newFolderImages[folderName]) newFolderImages[folderName] = [];
                newFolderImages[folderName].push({
                  src: convertDriveLink(rowData.Source_Drive),
                  caption: rowData.Legende || rowData.Nom_Photo
                });
              }
            }
          });

          folderImages = newFolderImages;
          loadingFoldersMessage.style.display = "none";
        } else {
          loadingFoldersMessage.textContent = "Aucune donnée trouvée dans Google Sheets.";
        }
      } catch (error) {
        console.error("Erreur Google Sheets:", error);
        loadingFoldersMessage.textContent = `Erreur: ${error.message}`;
      } finally {
        initializeFolderView();
      }
    }

    // --- Affichage dossiers ---
    function renderFolderCards() {
      folderGrid.innerHTML = "";
      const uniqueFolders = Object.keys(folderImages);
      if (uniqueFolders.length > 0) {
        uniqueFolders.forEach(folderName => {
          const cardLink = document.createElement("a");
          cardLink.href = "#";
          cardLink.classList.add("card", "folder-card");
          cardLink.dataset.folder = folderName;
          cardLink.innerHTML = `
            <img src="UNC de Baugy_fichiers/photos/folder-icon.png" alt="Icone Dossier" class="folder-icon" onerror="this.onerror=null;this.src='https://placehold.co/90x90/ccddff/000000?text=Dossier';">
            <div class="folder-name">${folderName}</div>
            <div class="folder-description">${folderImages[folderName].length} photos</div>
          `;
          cardLink.addEventListener("click", (event) => {
            event.preventDefault();
            showGalleryView(folderName);
          });
          folderGrid.appendChild(cardLink);
        });
      } else {
        folderGrid.innerHTML = "<p style='text-align:center; padding:20px;'>Aucun dossier disponible.</p>";
      }
    }

    function initializeFolderView() {
      renderFolderCards();
      showFolderView();
    }

    // --- Test connexion Google Sheets ---
    async function testGoogleSheetConnection() {
      const testUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}?key=${GOOGLE_SHEET_API_KEY}`;
      try {
        const response = await fetch(testUrl);
        if (!response.ok) throw new Error("Erreur HTTP " + response.status);
        const data = await response.json();
        console.log("✅ Connexion réussie à Google Sheets :", data);
        alert("✅ Connexion réussie à Google Sheets !");
      } catch (error) {
        console.error("❌ Échec de la connexion à Google Sheets :", error);
        alert("❌ Impossible de se connecter à Google Sheets : " + error.message);
      }
    }

    // --- Initialisation ---
    document.addEventListener("DOMContentLoaded", async () => {
      await fetchGoogleSheetData();
      lightboxModal.addEventListener("click", (event) => { if (event.target === lightboxModal) closeLightBox(); });
      document.addEventListener("keydown", (event) => { if (event.key === "Escape" && lightboxModal.style.display === "flex") closeLightBox(); });
    });
</script>

</body>
</html>
